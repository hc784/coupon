<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ì¿ í° ëŒ€ê¸°ì—´</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 4rem auto; text-align: center; }
        #status { margin-top: 1.5rem; font-weight: bold; }
        #position { margin-top: .75rem; font-size: 1.25rem; color: #0a84ff; }
        button { padding: .6rem 1.4rem; font-size: 1rem; border: none; border-radius: .5rem; background: #0a84ff; color: #fff; cursor: pointer; }
        button[disabled] { background: #999; cursor: default; }
    </style>
</head>
<body>
    <h1>ì„ ì°©ìˆœ ì¿ í° ëŒ€ê¸°ì—´</h1>

    <!-- ì‚¬ìš©ì IDëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ëª¨ë¸ë¡œ ì£¼ì…: model.addAttribute("userId", userId); -->
    <p th:text="'ì‚¬ìš©ì ID: ' + ${userId}"></p>

    <button id="joinBtn">ì¿ í° ì‹ ì²­</button>

    <p id="status"></p>
    <p id="position"></p>

    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸: Thymeleaf ì¸ë¼ì¸ ì‚¬ìš© -->
    <script th:inline="javascript">
        const userId = /*[[${userId}]]*/ 0;   // fallback 0 when SSR ë¯¸ì ìš©

        async function joinQueue() {
            // ì‹ ì²­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('joinBtn').disabled = true;

            try {
                const res = await fetch(`/api/coupon?userId=${userId}`, { method: 'POST' });
                document.getElementById('status').innerText = await res.text();

                if (res.ok) {
                    pollPosition();
                } else {
                    document.getElementById('joinBtn').disabled = false;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = 'ì„œë²„ ì˜¤ë¥˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”';
                document.getElementById('joinBtn').disabled = false;
            }
        }

        async function pollPosition() {
            try {
                const res = await fetch(`/api/queue/${userId}`);
                if (!res.ok) throw new Error('poll failed');
                const data = await res.json();

                if (data.status === 'DONE') {
                    document.getElementById('position').innerText = 'ğŸ‰ ë°œê¸‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                    document.getElementById('status').innerText  = '';
                    return; // polling ì¢…ë£Œ
                }

                document.getElementById('position').innerText = `í˜„ì¬ ìˆœìœ„: ${data.position}`;
                setTimeout(pollPosition, 1000); // 1ì´ˆ í›„ ì¬í˜¸ì¶œ
            } catch (e) {
                console.error(e);
                setTimeout(pollPosition, 2000); // ì—ëŸ¬ ì‹œ 2ì´ˆ í›„ ì¬ì‹œë„
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('joinBtn').addEventListener('click', joinQueue);
        });
    </script>
</body>
</html>
